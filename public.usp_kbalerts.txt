-- FUNCTION: public.usp_kbalertsjson

-- DROP FUNCTION public.usp_kbalertsjson;

CREATE OR REPLACE FUNCTION public.usp_kbalerts(
	input json)
RETURNS json
    LANGUAGE 'plpgsql'
    COST 100.0
    VOLATILE 
AS $function$

DECLARE
	VTRAN		VARCHAR(30);
	VAlertId	int;
	VAlertName	varchar(255);
	VAlertDescription	varchar(255);
	VLatestkpiid	int;
	VALERT_KPI	int;
	VSourceid	int;
	VTemplateId	int;
	VEmailid	varchar(255);
	VCreated_By	int;
	VID		int;
	VActiondate	timestamp default(current_timestamp at time zone 'utc')	;	
	VSeverity	smallint;
	VPriority	smallint;
	VGroupid	int;
	VAlertfor	smallint;
	VAlertcriteria	smallint;
	VSendemailcount	smallint;	
	VAlertexpression	text;
	VEmailtimeperiod	smallint;
	VEmailuom		varchar(100);
	VEmailrule		smallint;
	VAlertfrequency		smallint;
	VAlertFrequencyuom	varchar(100);
	VRichTextMetricsDetails	text;
	VEmailtemplate varchar(500);
	VEmailTemplateID	int;
	VSourceTypeid	int;
	VMultidatasource bit;
	VRichTextmetricDetails	text;
	Valertrole	json;
	VResult	json;
	VEMAILdetid	 int;
	VStartTime	varchar(50);
	VEndTime	varchar(50);
	VRuleCriteria	varchar(10);
	VScheduletype varchar(30);
	

begin

drop table if exists temps;
drop table if exists TEMPACTIONTABLE;
drop table if exists users ;
drop table if exists TEMPALERTSEMAIL;

create temp table temps(id serial,ivalue json);
create temp table TEMPACTIONTABLE (ActionID INT);
create temp table users (id serial,userid int);
create temp table TEMPALERTSEMAIL( ALERT_ID BIGINT,ACTIONGROUPID int,NotificationType varchar(50),MAILTO text,MAILCC text,MAILBCC text,MAILSUBJECT text,EmailTemplate text
,AddEmailRule bigint,uom varchar(50),APIBODY varchar(1000),apiaction varchar(20),headers varchar(1000));

insert into temps(ivalue)
select input;

select ivalue->'ALERT'->> 'TRANSTYPE' ,ivalue->'ALERT'->> 'LoginId'
,ivalue->'ALERT'->> 'VID'
,ivalue->'ALERT'->> 'TEMPLATE_ID'
,ivalue->'ALERT'->> 'ALERT_NAME'
,ivalue->'ALERT'->> 'ALERT_ID'
,ivalue->'ALERT'->> 'EMAIL_ID'
,ivalue->'ALERT'->> 'ALERT_KPI'
,ivalue->'ALERT'->> 'ALERT_DESCRIPTION'
,ivalue->'ALERT'->> 'SEVERITY'
,ivalue->'ALERT'->> 'PRIORITY'
,ivalue->'ALERT'->> 'GROUPID'
,ivalue->'ALERT'->> 'ALERTFOR'
,ivalue->'ALERT'->> 'ALERTCRITERIA'
,ivalue->'ALERT'->> 'SendEmailCount'
,ivalue->'ALERT'->> 'ALERTEXPRESSION'
,ivalue->'ALERT'->> 'EmailTimePeriod'
,ivalue->'ALERT'->> 'EmailUOM'
,ivalue->'ALERT'->> 'EmailRule'
,ivalue->'ALERT'->> 'ALERTFREQUENCY'
,ivalue->'ALERT'->> 'FREQUENCYUOM'
,ivalue->'ALERT'->> 'RichTextMetricsDetails'
,cast(ivalue->'ALERT'->> 'EMAIL_ID' as int)
,ivalue->'ALERT'->> 'StartTime'
,ivalue->'ALERT'->> 'EndTime'
,ivalue->'ALERT'->> 'RuleCriteria'
,ivalue->'ALERT'->> 'Type'
into
VTRAN,VCreated_By,VID,VTemplateId,VAlertName,VAlertId,VEmailid,VALERT_KPI,VAlertDescription,VSeverity,VPriority	,VGroupid,VAlertfor,VAlertcriteria,VSendemailcount,	
VAlertexpression,VEmailtimeperiod,VEmailuom,VEmailrule,VAlertfrequency,VAlertFrequencyuom,VRichTextMetricsdetails,VEMAILdetid
,VStartTime,VEndTime,VRuleCriteria,VScheduletype	
from temps limit 1;

insert into users(userid)
select userid
From
KBUserCustomerMapping A
Inner join
(
	Select customerid 
	from KBUserCustomerMapping
	where userid=VCreated_by
) B  on A.customerid=B.customerid
;
  
Select KPI_ID, ismultidatasource,source_id,createdby  into Vlatestkpiid, VMultidatasource,VSourceTypeid ,VCreated_by 
from KBKpiMst 
where coalesce(ORIGINALID, KPI_ID)=VALERT_KPI and ISACTIVE='1' 
limit 1;

If coalesce(VMultidatasource,'0')='1' then
begin
VSourceTypeid:=0;
end;
end if;

		INSERT INTO TEMPACTIONTABLE 
	  	Select KStatus.statusid
		from kbkpirule Ranges
		Join KBTEMPLATEGROUPINGMST Groups on Ranges.action_groupid=Groups.GROUPDETAILID
		Join kbkpistatus KStatus on Ranges.ruleaction=KStatus.status
		where Ranges.kpi_id=Vlatestkpiid 
		and Groups.ACTIONID=VgroupID
		and Groups.TEMPLATEID=VTEMPLATEID
;
If lower(VTran)='gettooltip' then
begin
VALERT_KPI:=(select ivalue->'ALERT'->> 'kpiid' from temps limit 1);

	Return(	select row_to_json(AA)
		from
		(
		select row_to_json(outputs) as "ALERTDETAILS"
		from
		(	
			select "ALERT","RANGES"
			from
			(
			select array_to_json(array_agg(row_to_json(output))) as "ALERT"
			from
			(
					select ROWNUMBER "ROWNUMBER"
					,ALERT_ID "ALERT_ID"
					,KPI_NAME "KPI_NAME"
					,ALERT_DESCRIPTION "ALERT_DESCRIPTION"
					,TEMPLATE_ID "TEMPLATE_ID"
					,ALERTFOR "ALERTFOR"
					,EVENTID "EVENTID"
					,ALERTFORNAME "ALERTFORNAME"
					,(RowNumber+RevRowNumber )-1 as "TotalRows"
					,CreatedBy "CreatedBy"
					,SOURCEID as "SOURCEID"
					,KPIID "KPIID"
					 from
							(
							Select   row_number() over(Order by B.ALERT_ID desc) as RowNumber
							,ROW_NUMBER() OVER(ORDER BY B.ALERT_ID ) RevRowNumber ,ALERT_ID,KPI_NAME,ALERT_DESCRIPTION,TEMPLATE_ID
							,ALERTFOR,EVENTID,ALERTFORNAME,CreatedBy,SOURCEID, KPIID
							from
							(
									Select ALERT_ID,A.KPI_NAME,ALERT_DESCRIPTION,A.TEMPLATE_ID ,ALERTFOR,coalesce(EVENTID,0) EVENTID
									,Case when A.ALERTFOR=0 Then km.KPI_NAME Else Problems.EVENT_SD End ALERTFORNAME
									,users.USER_NAME CreatedBy
									,source_id SOURCEID, kpi_id KPIID
									From
											
									(
											SELECT  AM.ALERT_ID,KM.KPI_NAME,am.ALERT_KPI,AM.ALERT_DESCRIPTION,AM.TEMPLATE_ID 
											,coalesce(AlertType,0) ALERTFOR,coalesce(EVENTID,0) EVENTID,AM.createdby CreatedBy
											FROM KBALERTMST AM
											Inner JOIN KBKPIMST KM ON AM.ALERT_KPI = KM.KPI_ID --AND AM.TEMPLATE_ID = @TEMPLATE_ID
											WHERE AM.ALERT_ID != 1 and coalesce(AlertType,0)=0 and AM.ISACTIVE='1'
											and exists (Select 1 from users B where AM.createdby=B.userid)
											Union All
				
											SELECT  AM.ALERT_ID,KM.EVENT_SD KPI_NAME,am.ALERT_KPI,AM.ALERT_DESCRIPTION,AM.TEMPLATE_ID 
											,coalesce(AlertType,0) ALERTFOR,coalesce(EVENTID,0) EVENTID,AM.createdby CreatedBy
											 FROM KBALERTMST AM
											Inner JOIN kbEventsmst KM ON AM.EVENTID = KM.EVENT_ID --AND AM.TEMPLATE_ID = @TEMPLATE_ID
											WHERE 
											AlertType=1 and AM.ISACTIVE='1' 
											and exists (Select 1 from users B where AM.createdby=B.userid)
									) A
									Join kbusermst users on A.createdby=users.user_id
									Left Outer  JOIN KBKPIMST KM ON A.ALERT_KPI = KM.KPI_ID 
									Left Outer  JOIN kbEventsmst Problems ON A.EVENTID = Problems.EVENT_ID 
									where exists (Select 1 from users B where KM.createdby=B.userid)
							 
							)B
							)c
							Order by ALERT_DESCRIPTION
			) output
			)A
			,
			(
				select array_to_json(array_agg(row_to_json(output))) as "RANGES"
				from
				(
				SELECT STATUSID AS "RANGEID",STATUS AS "RANGENAME"
				FROM KBKPISTATUS KM 
				where  exists (Select 1 from users B where KM.createdby=B.userid) 
				Order by Status
				) output

			)B
		)outputs
		)AA
		)
;

end;
elseIf lower(VTran)='createalert' then
begin

If VTEMPLATEID=0 or VTEMPLATEID is null
then 
VTEMPLATEID=2;
End if;
		if exists(select 1 from kbalertmst A where alert_description =VAlertDescription --then
					and exists(Select 1 from users B where A.createdby=B.userid)) then
		begin  

			Return
			(
				select row_to_json(aa)
				from
				(
					select row_to_json(a) "ALERTDETAILS"
					from
					( 
					select -1  as "Result", 0 as "ErrorMessage", 0 as "ErrorCode"
					)a
				)aa
			);
					
		end;  
		end if;

		INSERT INTO KBALERTMST
					( 
					  ALERT_NAME ,
					  ALERT_KPI ,
					  ALERT_DESCRIPTION ,
					  SEVERITY ,
					  PRIORITY ,
					  MODIFIEDBY ,
					  MODIFIEDDATE ,
					  CREATEDBY ,
					  CREATEDDATE,
					   TEMPLATE_ID ,
					  AlertType
					 )

					SELECT 	VAlertName
						  ,VALERT_KPI
						  ,VALERTDESCRIPTION
						  ,VSEVERITY
						  ,VPRIORITY
						  ,VCreated_by
						  ,VActionDate
						  ,VCreated_by
						  ,VActionDate
						  ,VTEMPLATEID
						  ,VAlertfor;

 
		VAlertId:=(SELECT currval(pg_get_serial_sequence('KBALERTMST','alert_id')));

		VEmailtemplate=VAlertDescription;

		If (select left(cast(ivalue-> 'ALERT'->'EntityDefinition' as text),1) from temps limit 1 )='[' then
		begin
		
			insert into kbalerts_entitydefinitionsmapping(alert_id,entitydef_id,createdby,createddate,modifiedby,modifieddate)
			select VAlertId Alertid, cast(EDScreen->>'id' as int) entitydefid, Vcreated_by,VActionDate,Vcreated_by,VActionDate
			from
			(
				Select json_array_elements(EDScreen) as EDScreen
				From
				(
					select ivalue->'ALERT'-> 'EntityDefinition' as EDScreen
					from temps limit 1
				)a
			) emap	
			
			;
		end;
		else
		begin
			insert into kbalerts_entitydefinitionsmapping(alert_id,entitydef_id,createdby,createddate,modifiedby,modifieddate)
			select * 
			from
			(
				select VAlertId Alertid, cast(ivalue->'ALERT'-> 'EntityDefinition'->>'id' as int) entitydefid, Vcreated_by createdby,VActionDate createddate
				,Vcreated_by modifiedby,VActionDate modifieddate
				from
				temps limit 1
			) A 
			where entitydefid!=0
			;

		end;
		end if;

		
		insert into kbeventemailmst_TempHold(tamplatename,EmailHtmlContent,EmailRichTextContent,"type",createddate,modifieddate,createdby,modifiedby,NotificationAlertType)
		select  VEmailtemplate EmailTemplate,NULL,NULL,'Alerts',VActionDate,VActionDate,Vcreated_by,Vcreated_by,VEmailrule;
		
		VEmailTemplateID:= (SELECT currval(pg_get_serial_sequence('kbeventemailmst_TempHold','templateid')));
			
  
	 if(VEmailTemplateID is not null or VEmailTemplateID!=0) then
	 Begin
 
		Insert into kbeventemailDetails_TempHold(templateid,eventid,EmailSubject,EmailTo,EmailCC,EmailBCC,mailcount,EmailRule,emailtimeperiod,emailuom,active,Metricplaceholder
		,createddate,modifieddate,createdby,modifiedby,AlertFrequency,AlertFrequencyUOM,ANotificationOperator,StartTime,EndTime,RuleCriteria,sch_uom,sch_type)
	
		select 	VEmailTemplateID,VALERTID,NULL,NULL, NULL, NULL,  VSendEmailCount
		,case when VEmailRule=0 or VEmailRule is null then 1 else VEmailrule end AddEmailRule 
		, VEmailTimePeriod
		, VEmailUOM
		,1
		, NULL
		,VActionDate
		,VActionDate
		,Vcreated_by
		,Vcreated_by
		,VAlertFrequency
		,VAlertFrequencyUOM
		,VAlertexpression
		,VStartTime	
		,VEndTime	
		,VRuleCriteria	
		,VEmailuom
		,VScheduletype

		;
		    
	END;
	End if;	

	INSERT INTO KBAlertAction
	( 
	  ALERT_ID ,
	  KPI_ID ,
	  ALERTACTION ,
	  CREATEDBY ,
	  ModifiedBy,
	  CREATEDDATE,
	  ModifiedDate,	
	  TEMPLATE_ID
	)
	Select
	  VALERTID 
	  ,coalesce(VALERT_KPI,Vlatestkpiid)
	  ,Actionid
	  ,VCreated_by
	  ,VCreated_by
	  ,VActiondate
	  ,VActiondate
	  ,VTEMPLATEID
	  
	from
	TEMPACTIONTABLE A
	where not exists(select 1 from KBAlertAction B where A.Actionid=cast(B.ALERTACTION as int) and B.ALERT_ID=VALERTID and B.kpi_id=coalesce(VALERT_KPI,Vlatestkpiid))
;

			Return(
				select row_to_json(a) 
				from
				(
					select row_to_json(output) as "ALERTDETAILS"
					from
					(

					SELECT VAlertId "ALERTID"
					,VALERTNAME "ALERT_NAME"
					,VTEMPLATEID "TEMPLATE_ID"
					,VSourceTypeid "SOURCE_ID"
					,(

						select string_agg(Aactions,';')
						from
						(
						select cast(alertaction as varchar(20)) as Aactions
						from kbalertaction Actions where Actions.alert_id=VALERTID and alertmst.alert_id=actions.alert_id
						)a
					) "ACTIONS"
					,VALERT_KPI "ALERT_KPI"
					,VALERTDESCRIPTION  "ALERT_DESCRIPTION"
					,VSEVERITY   "SEVERITY"
					,VPRIORITY "PRIORITY"
					,VAlertfor "ALERTFOR"
					,kpis.KPI_NAME as "KPI_NAME"
					,kpis.KPI_DESCRIPTION as "KPI_DESCRIPTION"
					,Kpis.SOURCE_ID as "SOURCE_ID"
					,Templates.TEMPLATE_NAME as "TEMPLATE_NAME"
					,VTRAN "TRANSTYPE"
					,coalesce(IsMailConfigured,'0') "EMAIL"
					,coalesce(IsSMSConfigured,'0') "SMS"
					,coalesce(IsAPIConfigured,'0') "API"
					,VID	"VID"
					,
					(  
						select Array_to_json(array_Agg(row_to_json(en))) "EntityDefinition"
						from
						(
							select maps.entitydef_id id, ents.entity_name "name"
							from kbalerts_entitydefinitionsmapping maps 
							join kbentitymst ents on maps.entitydef_id=ents.entitydef_id 
							where maps.alert_id=alertmst.alert_id and maps.isactive=1
						) en	
					) 
					from
					kbalertmst alertmst 
					Left join KBKpiMst Kpis on VALERT_KPI=Kpis.KPI_ID
					Join KBTemplateMst Templates on VTEMPLATEID=TEmplates.TEMPLATE_ID
					where alertmst.alert_id=VAlertId
					) output 
				)a
			);
End;
Elseif Lower(Vtran)='getdetail' Then
Begin

Valertrole:=(
		select  array_to_json(array_agg(row_to_json(a))) as "ROLE"
		from
		(
			SELECT RM.ROLE_ID,RM.ROLE_NAME,coalesce(RM.ROLE_DESC,'') AS ROLE_DESC
			FROM KBALERTROLE AR 
			INNER JOIN KBROLEMST RM ON AR.ROLE_ID = RM.ROLE_ID 
			WHERE AR.ALERT_ID = VAlertId
			--FOR XML RAW('ROLE')
		)a
		);	
			
		if(
			Select sum(Records)
			From
			(
			select count(1) Records 
			from kbeventemailDetails Details
			join KBALERTMST AM on Am.ALERT_ID=Details.eventid
			join kbeventemailmst MailMst on MailMst.templateid=Details.templateid	  
			where AM.Alert_Id=VALERTID and  MailMst.type='Alerts' and Details.Active='1'
			Union
			select count(1) 
			from kbeventemailDetails_TempHold Details
			join KBALERTMST AM on Am.ALERT_ID=Details.eventid
			join kbeventemailmst_TempHold MailMst on MailMst.templateid=Details.templateid	  
			where AM.Alert_Id=VALERTID and  MailMst.type='Alerts' and Details.Active='1'
			) SA
		  )>0 Then
	 Begin
	 
 	 
	  VResult:= (

			select row_to_json(alertdetail) as "ALERTDETAILS"
			from
			(
			select Array_to_json(Array_agg(row_to_json(alerts))) as "ALERT"			
			from
			(
			SELECT   
			 KM.KPI_NAME "KPI_NAME"
			,AM.ALERT_NAME "ALERT_NAME"
			,AM.ALERT_DESCRIPTION "ALERT_DESCRIPTION"
			,AM.SEVERITY "SEVERITY"
			,AM.PRIORITY "PRIORITY"
			,AD.MAILBCC "MAILBCC"
			,AD.MAILBODY "MAILBODY"
			,AD.MAILCC  "MAILCC"
			,AD.MAILSUBJECT  "MAILSUBJECT"
			,AD.MAILTO "MAILTO"
			,AD.TEMPLATE_ID "TEMPLATE_ID"
			,(SELECT mailto FROM KBALERTDETAIL WHERE ALERT_ID=VALERTID and ISACTIVE='1') as "EMAILEXIST"
			,Valertrole as "ROLE"
			,coalesce(AlertType,0) "ALERTFOR"
			,AM.EVENTID  "EVENTID"
			,KM.KPI_ID "KPI_ID"
			, coalesce(Details.EmailHtmlContent,tempMailMst.EmailHtmlContent) "EmailHtmlContent"
			, coalesce(Details.EmailRichTextContent,tempMailMst.EmailRichTextContent) "EmailRichTextContent"
			, coalesce(Details.EmailTo, tempDetails.EmailTo ) "EmailTo"
			, coalesce(Details.EmailBCC, tempDetails.EmailBCC) "EmailBCC"
			, coalesce(Details.EmailCC, tempDetails.EmailCC) "EmailCC"
			, coalesce(Details.EmailSubject,tempDetails.EmailSubject) "EmailSubject"
			,coalesce(MailMst.tamplatename,tempMailMst.tamplatename) "EmailTemplate"
			, coalesce(Details.Metricplaceholder,tempDetails.Metricplaceholder) as "RichTextMetricsDetails"
			, coalesce(Details.EmailRule, tempDetails.EmailRule) "AddEmailRule"
			, coalesce(Details.mailcount,tempDetails.mailcount) "SendEmailCount"
			, coalesce(Details.EmailTimePeriod,tempDetails.EmailTimePeriod) "EmailTimePeriod"
			, coalesce(Details.EmailUOM,tempDetails.EmailUOM ) "EmailUOM"
			, coalesce(MailMst.NotificationAlertType,tempMailMst.NotificationAlertType) "NotificationAlertType"
			, coalesce(Details.AlertFrequency,tempDetails.AlertFrequency) "AlertFrequency"
			, coalesce(Details.AlertFrequencyUOM,tempDetails.AlertFrequencyUOM) "AlertFrequencyUOM"
			, coalesce(Details.StartTime,tempDetails.StartTime)	"StartTime"	
			, coalesce(Details.EndTime,tempDetails.EndTime)	"EndTime"	
			, coalesce(Details.RuleCriteria,tempDetails.RuleCriteria)	"RuleCriteria"	
			,coalesce(Details.bodyformat,tempDetails.bodyformat )  "datatype"
			,tempDetails.sch_type "Type"
			,
				(
				select row_to_json(aactions) as "Rules"
				from
				(
					Select Array_to_json(Array_agg(row_to_json(actions)))as "Rule"
					from	
					(
					Select ACTIONS.ALERT_ID "ALERT_ID", ASTATUS.STATUS "ACTIONNAME",AGROUPS.ACTION_CUSTOMIZE_NAME "GROUPNAME",AGROUPS.ACTIONID "GROUPID"
					from kbalertaction Actions 
					Join kbkpistatus AStatus on cast(Actions.alertaction as int)=AStatus.statusid
					Join (
							Select A.ruleaction, coalesce(B.originalid,B.kpi_id) kpi_id,action_groupid
							from 
							kbkpirule  A
							Join kbkpimst B on A.kpi_id=B.kpi_id
							where A.isactive='1' and B.isactive='1' --and B.kpi_id=20035
						) Krule on Astatus.status=Krule.ruleaction and Actions.kpi_id=krule.kpi_id
					Join KBTEMPLATEGROUPINGMST AGroups on Krule.action_groupid=AGroups.GROUPDETAILID
					where AM.alert_id=Actions.alert_id and Actions.alert_id=VALERTID and Actions.isactive='1'
					--and exists (Select 1 from users BB where AStatus.createdby=BB.userid)
					--For xml RAW('Rule'), Root('Rules')
					) actions
				 )aactions
				 )
			,
					(  
						select Array_to_json(array_Agg(row_to_json(en))) "EntityDefinition"
						from
						(
							select maps.entitydef_id id, ents.entity_name "name"
							from kbalerts_entitydefinitionsmapping maps 
							join kbentitymst ents on maps.entitydef_id=ents.entitydef_id 
							where maps.alert_id=AM.alert_id and maps.isactive=1
						) en	
					) 	 
			
		FROM KBALERTMST AM
			LEFT OUTER JOIN KBALERTDETAIL AD ON AM.ALERT_ID = AD.ALERT_ID 
			Left Outer  JOIN KBKPIMST KM ON AM.ALERT_KPI = KM.KPI_ID 
			Left Outer  JOIN kbEventsmst Problems ON AM.EVENTID = Problems.EVENT_ID
			Left outer Join kbeventemailDetails Details on Details.eventid=AM.ALERT_ID
			Left outer join kbeventemailmst MailMst on MailMst.templateid=Details.templateid
			Left outer Join kbeventemailDetails_TempHold tempDetails on tempDetails.eventid=AM.ALERT_ID
			Left outer join kbeventemailmst_TempHold tempMailMst on tempMailMst.templateid=tempDetails.templateid
			WHERE AM.ALERT_ID = VALERTID   and ( MailMst.type='Alerts' or tempMailMst.type='Alerts')   and AM.Isactive='1'
			--FOR XML RAW('ALERT'), ROOT ('ALERTDETAILS')

			) alerts
		)alertdetail	
		);
END;

else
	Begin
	 
			VResult:= (
			select row_to_json(alertdetail) as "ALERTDETAILS"
			from
			(
			select Array_to_json(Array_agg(row_to_json(alerts))) as "ALERT"			
			from
			(
			 SELECT KM.KPI_NAME "KPI_NAME"
			,AM.ALERT_NAME "ALERT_NAME"
			,AM.ALERT_DESCRIPTION "ALERT_DESCRIPTION"
			,AM.SEVERITY "SEVERITY"
			,AM.PRIORITY "PRIORITY"
			,AD.MAILBCC "MAILBCC"
			,AD.MAILBODY "MAILBODY"
			,AD.MAILCC  "MAILCC"
			,AD.MAILSUBJECT  "MAILSUBJECT"
			,AD.MAILTO "MAILTO"
			,AD.TEMPLATE_ID "TEMPLATE_ID"
			,(SELECT mailto FROM KBALERTDETAIL WHERE ALERT_ID=VALERTID and ISACTIVE='1') as "EMAILEXIST"
			,Valertrole as "ROLE"
			,coalesce(AlertType,'') "ALERTFOR"
			,AM.EVENTID  "EVENTID"
			,KM.KPI_ID "KPI_ID"
			,'' "EmailHtmlContent"
			,'' "EmailRichTextContent"
			,'' "EmailTo"
			,'' "EmailBCC"
			,'' "EmailCC"
			,'' "EmailSubject"
			,'' "EmailTemplate"
			,''as "RichTextMetricsDetails"
			,'' "AddEmailRule"
			,'' "SendEmailCount"
			,'' "EmailTimePeriod"
			,'' "EmailUOM"
			,'' "NotificationAlertType"
			,
				(
				select row_to_json(aactions) as "Rules"
				from
				(
					Select Array_to_json(Array_agg(row_to_json(actions)))as "Rule"
					from	
					(
					Select ACTIONS.ALERT_ID as "ALERT_ID", ASTATUS.STATUS "ACTIONNAME",AGROUPS.ACTION_CUSTOMIZE_NAME "GROUPNAME",AGROUPS.ACTIONID "GROUPID"
					from kbalertaction Actions 
					Join kbkpistatus AStatus on Actions.alertaction=AStatus.statusid
					Join (
							Select A.ruleaction, coalesce(B.originalid,B.kpi_id) kpi_id,action_groupid
							from 
							kbkpirule  A
							Join kbkpimst B on A.kpi_id=B.kpi_id
							where A.isactive='1' and B.isactive='1' --and B.kpi_id=20035
						) Krule on Astatus.status=Krule.ruleaction and Actions.kpi_id=krule.kpi_id
					Join KBTEMPLATEGROUPINGMST AGroups on Krule.action_groupid=AGroups.GROUPDETAILID
					where AM.alert_id=Actions.alert_id and Actions.alert_id=VALERTID and Actions.isactive='1'
					and exists (Select 1 from users BB where AStatus.createdby=BB.userid)
					--For xml RAW('Rule'), Root('Rules')
					) actions
				 )aactions
				 )
			
			FROM KBALERTMST AM
			LEFT OUTER JOIN KBALERTDETAIL AD ON AM.ALERT_ID = AD.ALERT_ID 
			Left Outer  JOIN KBKPIMST KM ON AM.ALERT_KPI = KM.KPI_ID 
			Left Outer  JOIN kbEventsmst Problems ON AM.EVENTID = Problems.EVENT_ID
			WHERE AM.ALERT_ID = VALERTID  and aM.isactive='1' 
			) alerts
		)alertdetail
		);
end;

End if;

Return(VResult);

End; 
ELSEIF lower(VTran)='addalertnotifications' Then
Begin 

	select ivalue->'ALERT'->> 'RichTextMetricsDetails' into VRichTextmetricDetails
	from temps limit 1;

	

	VEmailTemplateID:= ( select templateid from kbeventemailDetails_TempHold where eventid=VALERTID);

	If lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='email' then
	begin
		Insert into TEMPALERTSEMAIL(NotificationType,ACTIONGROUPID,MAILTO,MAILCC,MAILBCC,MAILSUBJECT,EmailTemplate)
		Select
				ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE
				,cast(ivalue->'ALERT'->'ACTIONS'->>'ACTIONGROUPID' as int) as ACTIONGROUPID
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailTo' EmailTo
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailCC' EmailCC
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailBCC' EmailBCC
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailSubject' EmailSubject
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailTemplate' EmailTemplate
		from temps limit 1;	
	end;
	elseIf lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='sms' then
	begin
		Insert into TEMPALERTSEMAIL(NotificationType,ACTIONGROUPID,MAILTO,EmailTemplate)
		Select
				ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE
				,cast(ivalue->'ALERT'->'ACTIONS'->>'ACTIONGROUPID' as int) as ACTIONGROUPID
				,ivalue->'ALERT'->'ACTIONS'->'SMSDETAILS'->>'SMSTo' EmailTo
				,ivalue->'ALERT'->'ACTIONS'->'SMSDETAILS'->>'SMSTemplate' EmailTemplate
		from temps limit 1;	
	end;
	elseIf lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='api' then
	begin

		Insert into TEMPALERTSEMAIL(NotificationType,ACTIONGROUPID,MAILTO,MAILCC,MAILBCC,MAILSUBJECT,EmailTemplate,uom,APIBODY,apiaction,headers)
		Select
				ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE
				,cast(ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'authenticationtype' as smallint) authenticationtype
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'url' url
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'username' username
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'password' "password"
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'appender' "appender"
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'parameters' parameters
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'datatype' datatype
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'body' body
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'apiaction' apiaction
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'headers' headers
		from temps limit 1;	

	end;
	end if;
	
		Update kbalertmst set IsMailConfigured= 
        case when lower(email.NotificationType)='email' then cast('1' as bit) else IsMailConfigured end 
		, isapiconfigured=case when lower(email.NotificationType)='api' then cast('1' as bit) else isapiconfigured  end 
        , issmsconfigured=case when lower(email.NotificationType)='sms' then cast('1' as bit) else issmsconfigured  end 
		From 
		(Select NotificationType,MAILTO From TEMPALERTSEMAIL where mailto !='' and MAilto is not null limit 1) email 
		where alert_id=VAlertId
 
;
		Insert into kbeventemailmst(tamplatename,"type",createddate,modifieddate,createdby,modifiedby,NotificationAlertType,notificationtype )
		Select tamplatename, "type",createddate,modifieddate,createdby,modifiedby,NotificationAlertType 
		,(Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' from temps limit 1) NOTIFICATIONTYPE
		from kbeventemailmst_TempHold 
		where templateid=VEmailTemplateID
; 
 		VEmailTemplateID:=(SELECT currval(pg_get_serial_sequence('kbeventemailmst','templateid')));

   
		Insert into kbeventemailDetails(templateid,eventid,EmailSubject,EmailTo,EmailCC,EmailBCC,Active,mailcount,EmailRule,emailtimeperiod,emailuom,Metricplaceholder,createddate,modifieddate,createdby,modifiedby,AlertFrequency,AlertFrequencyUOM,ANotificationOperator
		,EmailHtmlContent,EmailRichTextContent,starttime,endtime,rulecriteria,method_type,authentication_type,bodyformat,api_headers)
		
		Select VEmailTemplateID templateid,eventid,MAILSUBJECT EmailSubject, MAILTO EmailTo, MAILCC EmailCC, MAILBCC EmailBCC,Active
		,mailcount, A.EmailRule,emailtimeperiod
		, emailuom 
		,case when lower(NotificationType)='api' then B.apibody else  VRichTextmetricDetails end Metricplaceholder, VActiondate createddate
		,VActiondate modifieddate, Vcreated_by createdby,Vcreated_by modifiedby,AlertFrequency,AlertFrequencyUOM,ANotificationOperator , B.emailtemplate
		, APIBODY,starttime,endtime,rulecriteria,B.apiaction,ACTIONGROUPID,b.uom bodyformat,cast(b.headers as json) headers
		from kbeventemailDetails_TempHold A
		Join TEMPALERTSEMAIL B on 1=1
		where eventid=VALERTID	
 ;

 Select A.alert_kpi,source_id into VALERT_KPI, VSourceId
 from kbalertmst A
 Join kbkpimst B on A.alert_kpi=B.kpi_id 
 where alert_id=VALERTID
 ;

		Vresult:=( 			
				Select row_to_json(alerts) as "ALERTDETAILS"
				from
				(
					Select VAlertId "ALERT_ID", VALERT_KPI "KPIID"
						,  (
							select case when coalesce(IsMultiDataSource,'0')='0' 
										then cast(source_id as varchar(50)) Else corr.SourceID End
							from kbkpimst kpis
							left outer join 
									(
									select Correlationid, string_agg(cast(SourceID as varchar(50)),';') Sourceid
									from
									CBCorrelationDetails 
									group by Correlationid
									)corr 
									on kpis.CorrelationID=corr.CorrelationID
							where coalesce(originalid,kpi_id)=VALERT_KPI and kpis.isactive='1'
						) "SOURCE_ID", VTRAN "TRANSTYPE"
					,(
						select string_agg(cast(alertaction as varchar(50)),';') 
						from kbalertaction Actions 
						where Actions.alert_id=VALERTID and actions.isactive=1
					) "ACTIONS"
					,Vcreated_by "LOGINID"
					,
					(

						Select Array_to_json(array_agg(row_to_json(emails))) as "EMAILDETAILS"
						from
						(
							Select templatedetailid "EmailID", A.eventid "AlertID",EmailSubject "EmailSubject",EmailTo "EmailTo",EmailCC "EmailCC"
							,EmailBCC "EmailBCC",A.EmailHtmlContent "EmailTemplate", B.NotificationAlertType "AddEmailRule"
							from kbeventemailDetails A
							Join kbeventemailmst B on A.templateid=B.templateid
							where A.eventid=VALERTID and "type"='Alerts' and B.templateid=VEmailTemplateID and lower(B.notificationtype)='email'
						)emails
					)
					,
					(

						Select Array_to_json(array_agg(row_to_json(emails))) as "APIDETAILS"
						from
						(
							Select templatedetailid "EmailID", A.eventid "AlertID",EmailSubject "appender"
							,EmailTo "url"
							,mailcount "authenticationtype",EmailCC "username",EmailBCC "password"
							,A.EmailHtmlContent "parameters"
							,B.NotificationAlertType "AddEmailRule"
							,bodyformat  "datatype"
							,emailuom "EmailUOM"
							,A.EmailRichTextContent "body" 
							,method_type "apiaction"
							,Authentication_type "authenticationtype"
							,A.api_headers "headers"
							from kbeventemailDetails A
							Join kbeventemailmst B on A.templateid=B.templateid
							where A.eventid=VALERTID and "type"='Alerts' and B.templateid=VEmailTemplateID and lower(B.notificationtype)='api'
						)emails
					)
					) alerts
					)
;
Return(select row_to_json(a) from (select VResult as "ALERTDETAILS") a);

End;
Elseif Lower(VTran)='update' then
begin
	Update kbeventemaildetails
		set 
		 mailcount=VSendEmailCount
		,EmailRule=VEmailRule
		,modifiedDate=VActionDate 
		,modifiedby=Vcreated_by
		,emailtimeperiod=VEmailTimePeriod
		,emailuom=VEmailUOM
		,starttime=VStartTime
		,endtime=VEndTime
		,rulecriteria=VRuleCriteria
		From
		kbeventemailmst b  
		where kbeventemaildetails.templateid=b.templateid and b."type"='Alerts' and kbeventemaildetails.eventid=VAlertId;

		delete from kbalerts_entitydefinitionsmapping where alert_id=VAlertId;
		
		If (select left(cast(ivalue-> 'ALERT'->'EntityDefinition' as text),1) from temps limit 1 )='[' then
		begin
		
			insert into kbalerts_entitydefinitionsmapping(alert_id,entitydef_id,createdby,createddate,modifiedby,modifieddate)
			select VAlertId Alertid, cast(EDScreen->>'id' as int) entitydefid, Vcreated_by,VActionDate,Vcreated_by,VActionDate
			from
			(
				Select json_array_elements(EDScreen) as EDScreen
				From
				(
					select ivalue->'ALERT'-> 'EntityDefinition' as EDScreen
					from temps limit 1
				)a
			) emap	
			
			;
		end;
		else
		begin
			insert into kbalerts_entitydefinitionsmapping(alert_id,entitydef_id,createdby,createddate,modifiedby,modifieddate)
			select * 
			from
			(
				select VAlertId Alertid, cast(ivalue->'ALERT'-> 'EntityDefinition'->>'id' as int) entitydefid, Vcreated_by createdby,VActionDate createddate
				,Vcreated_by modifiedby,VActionDate modifieddate
				from
				temps limit 1
			) A 
			where entitydefid!=0
			;

		end;
		end if;

		if exists (select 1 from kbeventemailDetails_TempHold a join kbeventemailmst_temphold b on a.templateid=b.templateid where eventid=VALERTID and b."type"='Alerts') Then
		Begin  

	 	 VEmailTemplateID:=(Select a.templateid from kbeventemailDetails_TempHold a 
					join kbeventemailmst_temphold b on a.templateid=b.templateid where eventid=VALERTID and b."type"='Alerts');

		 VEmailtemplate:=VAlertDescription;
 		
		Update kbeventemailmst_TempHold set tamplatename = VEmailtemplate
		,modifieddate=VActionDate, Modifiedby=Vcreated_by
		,NotificationAlertType=VEmailRule
		where templateid=VEmailTemplateID;
		
	
		Update kbeventemailDetails_TempHold 
		set 
		mailcount=  VSendEmailCount
		,EmailRule=case when VEmailRule=0 or VEmailRule is null then 1 else VEmailRule end 
		,emailtimeperiod= VEmailTimePeriod
		,emailuom= VEmailUOM
		,modifieddate=VActionDate
		,Modifiedby=VCreated_by
		,AlertFrequency= VAlertFrequency
		,AlertFrequencyUOM= VAlertFrequencyUOM
		,ANotificationOperator= VAlertexpression
		,starttime=Vstarttime
		,endtime=Vendtime	
		,rulecriteria=Vrulecriteria
		,sch_type=Vscheduletype
		,sch_uom=VEmailUOM
		where templateid=VEmailTemplateID;
		End;
		End if;

		UPDATE KBALERTMST
		SET 
		 ALERT_DESCRIPTION = VALERTDESCRIPTION
		,SEVERITY = VSEVERITY
		,PRIORITY = VPRIORITY
		,CREATEDDATE = VActiondate
		,MODIFIEDBY = VCREATED_BY
		,MODIFIEDDATE = VActiondate
		,TEMPLATE_ID = VTEMPLATEID
		,AlertType=VAlertfor
		where ALERT_ID = VALERTID ;

		
		Update KBAlertAction Set IsActive=0
		,modifieddate=VActiondate
		,Modifiedby=VCreated_by
		where 
		 alert_id=VALERTID ;

		INSERT INTO KBAlertAction
		( 
		  ALERT_ID ,
		  KPI_ID ,
		  ALERTACTION ,
		  CREATEDBY ,
		  ModifiedBy,
		  CREATEDDATE,
		  ModifiedDate,	
		  TEMPLATE_ID
		)
		Select
		  VALERTID 
		  ,coalesce(VALERT_KPI,Vlatestkpiid)
		  ,Actionid
		  ,VCreated_by
		  ,VCreated_by
		  ,VActiondate
		  ,VActiondate
		  ,VTEMPLATEID
		from
		TEMPACTIONTABLE
		where Not exists(Select 1 from KBAlertAction AAction Where ALERT_ID=VALERTID and cast(ALERTACTION as int)=ActionID and Isactive='1');

			Return(
				select row_to_json(a) 
				from
				(
					select row_to_json(output) as "ALERTDETAILS"
					from
					(

					SELECT VAlertId "ALERTID"
					,VALERTNAME "ALERT_NAME"
					,VTEMPLATEID "TEMPLATE_ID"
					,VSourceTypeid "SOURCE_ID"
					,(

						select string_agg(Aactions,';')
						from
						(
						select cast(alertaction as varchar(20)) as Aactions
						from kbalertaction Actions where Actions.alert_id=VALERTID and alertmst.alert_id=actions.alert_id
						)a
					) "ACTIONS"
					,VALERT_KPI "ALERT_KPI"
					,VALERTDESCRIPTION  "ALERT_DESCRIPTION"
					,VSEVERITY   "SEVERITY"
					,VPRIORITY "PRIORITY"
					,VAlertfor "ALERTFOR"
					,kpis.KPI_NAME as "KPI_NAME"
					,kpis.KPI_DESCRIPTION as "KPI_DESCRIPTION"
					,Kpis.SOURCE_ID as "SOURCE_ID"
					,Templates.TEMPLATE_NAME as "TEMPLATE_NAME"
					,VTRAN "TRANSTYPE"
					,coalesce(IsMailConfigured,'0') "EMAIL"
					,coalesce(IsSMSConfigured,'0') "SMS"
					,coalesce(IsAPIConfigured,'0') "API"
					,VID	"VID"
					,
					(  
						select Array_to_json(array_Agg(row_to_json(en))) "Entitydefid"
						from
						(
							select maps.entitydef_id id, ents.entity_name "name"
							from kbalerts_entitydefinitionsmapping maps 
							join kbentitymst ents on maps.entitydef_id=ents.entitydef_id 
							where maps.alert_id=alertmst.alert_id and maps.isactive=1
						) en	
					) 
					from
					kbalertmst alertmst 
					Left join KBKpiMst Kpis on VALERT_KPI=Kpis.KPI_ID
					Join KBTemplateMst Templates on VTEMPLATEID=TEmplates.TEMPLATE_ID
					where alertmst.alert_id=VAlertId
					) output 
				)a
			);
		
end;
Elseif Lower(VTran)='getalertnotifications' Then
Begin

Vresult:=
	( 

		Select Row_to_json(output) as "ALERTDETAILS"
		From
		(
		Select VAlertId "ALERT_ID",
				
				(
					Select Array_to_json(Array_agg(Row_to_json(emails))) As "EMAILDETAILS"
					From
					(
						Select templatedetailid "EmailID",eventid "AlertID",EmailSubject "EmailSubject",EmailTo "EmailTo",EmailCC "EmailCC",EmailBCC "EmailBCC"
						,A.EmailHtmlContent "EmailTemplate", B.NotificationAlertType "AddEmailRule"
						from kbeventemailDetails A
						Join kbeventemailmst B on A.templateid=B.templateid
						where eventid=VALERTID and Type='Alerts' and lower(B.notificationtype)='email'
						--For XML PATH('EMAILDETAILS')
					)as emails
				)
				,
				(

					Select Array_to_json(array_agg(row_to_json(emails))) as "APIDETAILS"
					from
					(
						Select templatedetailid "EmailID", A.eventid "AlertID",EmailSubject "appender"
						,EmailTo "url"
						,authentication_type "authenticationtype",EmailCC "username",EmailBCC "password"
						,A.EmailHtmlContent "parameters"
						,B.NotificationAlertType "AddEmailRule"
						,bodyformat "datatype"
						,emailuom "EmailUOM"
						,A.EmailRichTextContent "body"
						,method_type "apiaction"
						from kbeventemailDetails A
						Join kbeventemailmst B on A.templateid=B.templateid
						where A.eventid=VALERTID and "type"='Alerts'   and lower(B.notificationtype)='api'
					)emails
				)
				,
				(

					Select Array_to_json(array_agg(row_to_json(emails))) as "SMSDETAILS"
					from
					(
						Select templatedetailid "EmailID", A.eventid "AlertID",EmailSubject "appender"
						,EmailTo "SMSTo"
						,authentication_type "authenticationtype",EmailCC "username",EmailBCC "password"
						,A.EmailHtmlContent "SMSTemplate"
						,B.NotificationAlertType "AddEmailRule"
						,bodyformat "datatype"
						,emailuom "EmailUOM"
						,A.EmailRichTextContent "body"
						,method_type "apiaction"
						from kbeventemailDetails A
						Join kbeventemailmst B on A.templateid=B.templateid
						where A.eventid=VALERTID and "type"='Alerts'   and lower(B.notificationtype)='sms'
					)emails
				)
		) output
	);

Return(Select Row_to_json(a) from( Select VResult as "ALERTDETAILS")a );

End;
Elseif Lower(VTran)='editalertnotifications' then
begin

	VEmailTemplateID:= ( select templateid from kbeventemailDetails where templatedetailid=VEMAILdetid);

	select ivalue->'ALERT'->> 'RichTextMetricsDetails' into VRichTextmetricDetails
	from temps limit 1;
		
	If lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='email' then
	begin
		Insert into TEMPALERTSEMAIL(NotificationType,ACTIONGROUPID,MAILTO,MAILCC,MAILBCC,MAILSUBJECT,EmailTemplate)
		Select
				ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE
				,cast(ivalue->'ALERT'->'ACTIONS'->>'ACTIONGROUPID' as int) as ACTIONGROUPID
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailTo' EmailTo
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailCC' EmailCC
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailBCC' EmailBCC
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailSubject' EmailSubject
				,ivalue->'ALERT'->'ACTIONS'->'EMAILDETAILS'->>'EmailTemplate' EmailTemplate
		from temps limit 1;	
	end;
	elseIf lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='api' then
	begin

		Insert into TEMPALERTSEMAIL(NotificationType,ACTIONGROUPID,MAILTO,MAILCC,MAILBCC,MAILSUBJECT,EmailTemplate,uom,APIBODY,apiaction,headers)
		Select
				ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE
				,cast(ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'authenticationtype' as smallint) authenticationtype
				--,cast(ivalue->'ALERT'->'ACTIONS'->>'ACTIONGROUPID' as int) as ACTIONGROUPID
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'url' url
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'username' username
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'password' "password"
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'appender' "appender"
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'parameters' parameters
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'datatype' datatype
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'body' body
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'apiaction' apiaction
				,ivalue->'ALERT'->'ACTIONS'->'APIDETAILS'->>'headers' headers
		from temps limit 1;	

	end;
	elseIf lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='sms' then
	begin

	
		Insert into TEMPALERTSEMAIL(NotificationType,ACTIONGROUPID,MAILTO,EmailTemplate)
		Select
				ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE
				,cast(ivalue->'ALERT'->'ACTIONS'->>'ACTIONGROUPID' as int) as ACTIONGROUPID
				,ivalue->'ALERT'->'ACTIONS'->'SMSDETAILS'->>'SMSTo' EmailTo
				,ivalue->'ALERT'->'ACTIONS'->'SMSDETAILS'->>'SMSTemplate' EmailTemplate
		from temps limit 1;	
	end;
	end if;

	update kbeventemailDetails  
		set emailto= B.MAILTO
		,EmailCC=B.MAILCC
		,EmailBCC=B.MAILBCC
		,EmailSubject=B.MAILSUBJECT
		,Metricplaceholder=case when lower(NotificationType)='api' then B.apibody else  VRichTextmetricDetails end
		,EmailHtmlContent=B.EmailTemplate
		,emailrichtextcontent=B.apibody
		,method_type=apiaction
		,bodyformat=b.uom
		,authentication_type=case when lower(cast((Select ivalue->'ALERT'->'ACTIONS'->> 'NOTIFICATIONTYPE' as NOTIFICATIONTYPE from temps limit 1) as varchar(10)))='api'  
						then ACTIONGROUPID else NULL End
		,api_headers=cast(b.headers as json)  
	from
	TEMPALERTSEMAIL B 
	where kbeventemailDetails.templatedetailid=VEMAILdetid ;

	  
	 
		Vresult:=( 			
				Select row_to_json(alerts) as "ALERTDETAILS"
				from
				(
					Select VAlertId "ALERT_ID", VALERT_KPI "KPIID"
						,  (
							select case when coalesce(IsMultiDataSource,'0')='0' 
										then cast(source_id as varchar(50)) Else corr.SourceID End
							from kbkpimst kpis
							left outer join 
									(
									select Correlationid, string_agg(cast(SourceID as varchar(50)),';') Sourceid
									from
									CBCorrelationDetails 
									group by Correlationid
									)corr 
									on kpis.CorrelationID=corr.CorrelationID
							where coalesce(originalid,kpi_id)=VALERT_KPI  and kpis.isactive='1'
						) "SOURCE_ID", VTRAN "TRANSTYPE"
					,(
						select string_agg(cast(alertaction as varchar(50)),';') 
						from kbalertaction Actions   
						where Actions.alert_id=VALERTID  and actions.isactive=1
					) "ACTIONS"
					,Vcreated_by "LOGINID"
					,
					(

					Select Array_to_json(array_agg(row_to_json(emails))) as "EMAILDETAILS"
					from
					(
						Select templatedetailid "EmailID", A.eventid "AlertID",EmailSubject "EmailSubject",EmailTo "EmailTo",EmailCC "EmailCC",EmailBCC "EmailBCC"
						,A.EmailHtmlContent "EmailTemplate", B.NotificationAlertType "AddEmailRule"
						from kbeventemailDetails A
						Join kbeventemailmst B on A.templateid=B.templateid
						where A.eventid=VALERTID and "type"='Alerts' and B.templateid=VEmailTemplateID
					)emails
					)
					,
					(

						Select Array_to_json(array_agg(row_to_json(emails))) as "APIDETAILS"
						from
						(
							Select templatedetailid "EmailID", A.eventid "AlertID",EmailSubject "appender"
							,EmailTo "url"
							,mailcount "authenticationtype",EmailCC "username",EmailBCC "password"
							,A.EmailHtmlContent "parameters"
							,B.NotificationAlertType "AddEmailRule"
							,bodyformat "datatype"
							,emailuom "EmailUOM"
							,A.EmailRichTextContent "body" 
							,method_type "apiaction"
							,A.api_headers "headers"
							from kbeventemailDetails A
							Join kbeventemailmst B on A.templateid=B.templateid
							where A.eventid=VALERTID and "type"='Alerts' and B.templateid=VEmailTemplateID and lower(B.notificationtype)='api'
						)emails
					)
					) alerts
					)
;
Return(select row_to_json(a) from (select VResult as "ALERTDETAILS") a);

end;

End if;

End

$function$;

ALTER FUNCTION public.usp_kbalerts(json)
    OWNER TO postgres;


